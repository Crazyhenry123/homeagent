# HomeAgent — API Reference

**Base URL:** `http://<ALB-DNS-NAME>` (currently `http://Deploy-Servi-XjO6myh4gADc-1702122244.us-east-1.elb.amazonaws.com`)

All endpoints are prefixed with `/api/` except the health check.

## Authentication

Most endpoints require a Bearer token obtained during registration:

```
Authorization: Bearer <device_token>
```

The token is a 64-character base64url string generated by `secrets.token_urlsafe(48)`.

---

## Endpoints

### Health Check

```
GET /health
```

No authentication required.

**Response (200):**
```json
{"status": "healthy"}
```

---

### Register Device

```
POST /api/auth/register
```

No authentication required. Requires a valid, unused invite code.

**Request:**
```json
{
  "invite_code": "AB12CD",
  "device_name": "iPhone 15 Pro",
  "platform": "ios",
  "display_name": "Mom"
}
```

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `invite_code` | string | Yes | 6-char hex code, case-insensitive |
| `device_name` | string | Yes | Human-readable device identifier |
| `platform` | string | Yes | `"ios"` or `"android"` |
| `display_name` | string | Yes | User's display name |

**Response (201):**
```json
{
  "user_id": "01JXYZ...",
  "device_token": "abc123...xyz789"
}
```

**Errors:**
| Status | Error |
|--------|-------|
| 400 | `"Missing required fields"` |
| 400 | `"Invalid platform. Must be 'ios' or 'android'"` |
| 400 | `"Invite code already used or expired"` |

**Notes:**
- Each invite code can only be used once.
- The `device_token` must be stored securely on the device and included in all subsequent requests.
- If the invite code was created with admin privileges, the user receives the `admin` role.

---

### Verify Token

```
POST /api/auth/verify
```

**Auth:** Bearer token required.

**Request:** Empty body.

**Response (200):**
```json
{
  "valid": true,
  "user_id": "01JXYZ...",
  "name": "Mom"
}
```

**Errors:**
| Status | Error |
|--------|-------|
| 401 | `"Missing Authorization header"` |
| 401 | `"Invalid or expired token"` |

---

### Create Invite Code (Admin)

```
POST /api/admin/invite-codes
```

**Auth:** Bearer token required. Must be admin.

**Request:** Empty body.

**Response (201):**
```json
{
  "code": "AB12CD",
  "expires_at": "2099-12-31T00:00:00+00:00"
}
```

**Errors:**
| Status | Error |
|--------|-------|
| 401 | Unauthorized |
| 403 | `"Admin access required"` |

---

### Send Chat Message (SSE)

```
POST /api/chat
```

**Auth:** Bearer token required.

**Request:**
```json
{
  "message": "How do I fix a leaky faucet?",
  "conversation_id": "01JXYZ..."
}
```

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `message` | string | Yes | User's message text |
| `conversation_id` | string | No | Omit to start a new conversation |

**Response (200):** `Content-Type: text/event-stream`

The response is a stream of Server-Sent Events (SSE). Each event is a `data:` line containing JSON:

```
data: {"type":"text_delta","content":"You can ","conversation_id":"01JXYZ..."}

data: {"type":"text_delta","content":"fix a leaky faucet by ","conversation_id":"01JXYZ..."}

data: {"type":"message_done","conversation_id":"01JXYZ...","message_id":"01JABC..."}
```

**Event types:**

| Type | Fields | Description |
|------|--------|-------------|
| `text_delta` | `content`, `conversation_id` | A chunk of the assistant's response |
| `message_done` | `conversation_id`, `message_id` | Stream complete. Message saved. |
| `error` | `content` | An error occurred during streaming |

**Errors:**
| Status | Error |
|--------|-------|
| 400 | `"message is required"` |
| 401 | Unauthorized |
| 404 | `"Conversation not found"` (if `conversation_id` doesn't exist or belongs to another user) |

**Notes:**
- When `conversation_id` is omitted, a new conversation is created automatically. The `conversation_id` is returned in the first `text_delta` event.
- The conversation title is set to the first 50 characters of the initial message.
- Up to 50 previous messages are sent as context to the AI model.
- The assistant's response is saved to the Messages table after streaming completes.

---

### List Conversations

```
GET /api/conversations?limit=20&cursor=<updated_at>
```

**Auth:** Bearer token required.

**Query Parameters:**

| Param | Type | Default | Notes |
|-------|------|---------|-------|
| `limit` | integer | 20 | Max conversations to return (1–100) |
| `cursor` | string | — | ISO 8601 timestamp for pagination |

**Response (200):**
```json
{
  "conversations": [
    {
      "conversation_id": "01JXYZ...",
      "user_id": "01JABC...",
      "title": "How do I fix a leaky faucet?",
      "created_at": "2026-02-28T12:00:00+00:00",
      "updated_at": "2026-02-28T12:05:00+00:00"
    }
  ],
  "next_cursor": "2026-02-28T11:50:00+00:00"
}
```

**Notes:**
- Conversations are sorted by `updated_at` descending (most recent first).
- `next_cursor` is present only if there are more results. Pass it as `cursor` in the next request.
- Only returns conversations belonging to the authenticated user.

---

### Get Conversation Messages

```
GET /api/conversations/<conversation_id>/messages?limit=50&cursor=<sort_key>
```

**Auth:** Bearer token required. Must own the conversation.

**Query Parameters:**

| Param | Type | Default | Notes |
|-------|------|---------|-------|
| `limit` | integer | 50 | Max messages to return (1–100) |
| `cursor` | string | — | `sort_key` value for pagination |

**Response (200):**
```json
{
  "messages": [
    {
      "conversation_id": "01JXYZ...",
      "sort_key": "2026-02-28T12:00:00+00:00#01JABC...",
      "message_id": "01JABC...",
      "role": "user",
      "content": "How do I fix a leaky faucet?",
      "created_at": "2026-02-28T12:00:00+00:00"
    },
    {
      "conversation_id": "01JXYZ...",
      "sort_key": "2026-02-28T12:00:05+00:00#01JDEF...",
      "message_id": "01JDEF...",
      "role": "assistant",
      "content": "You can fix a leaky faucet by...",
      "created_at": "2026-02-28T12:00:05+00:00",
      "model": "us.anthropic.claude-opus-4-6-v1",
      "tokens_used": 150
    }
  ],
  "next_cursor": "2026-02-28T12:00:05+00:00#01JDEF..."
}
```

**Notes:**
- Messages are sorted chronologically (oldest first).
- `model` and `tokens_used` are present only on assistant messages.
- Returns 404 if the conversation doesn't exist or belongs to another user.

---

### Delete Conversation

```
DELETE /api/conversations/<conversation_id>
```

**Auth:** Bearer token required. Must own the conversation.

**Response (200):**
```json
{"success": true}
```

**Errors:**
| Status | Error |
|--------|-------|
| 401 | Unauthorized |
| 404 | Conversation not found or not owned by user |

**Notes:**
- Deletes the conversation and all its messages.
- This operation is irreversible.

---

## Error Response Format

All error responses follow this structure:

```json
{
  "error": "Human-readable error message"
}
```

## Rate Limits

No application-level rate limits are currently enforced. The system relies on:
- AWS ALB connection limits
- DynamoDB on-demand throughput
- Bedrock model invocation quotas
